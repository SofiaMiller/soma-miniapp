<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOMA</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Arial; padding: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .q { margin: 12px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
    .primary { background:#111; color:#fff; border-color:#111; }
    input[type="range"] { width: 100%; }
    .muted { opacity: .7; font-size: 13px; }
    h1 { margin: 0 0 8px; }
  </style>
</head>
<body>
  <h1>SOMA</h1>
  <div class="muted" id="who"></div>

  <div class="card" id="today">
    <div class="muted">Today</div>
    <div style="font-size:28px; font-weight:700" id="score">—</div>
    <div id="insight" class="muted">Complete a check-in to see your SOMA.</div>
    <div class="row" style="margin-top:10px">
      <button class="primary" id="openCheckin">Check in (30 sec)</button>
    </div>
  </div>

  <div class="card" id="checkin" style="display:none">
    <div class="muted">Check-in</div>

    <div class="q">
      <div>Sleep (1–5)</div>
      <input id="sleep" type="range" min="1" max="5" value="3" />
      <div class="muted">Value: <span id="sleepV">3</span></div>
    </div>

    <div class="q">
      <div>Energy (1–5)</div>
      <input id="energy" type="range" min="1" max="5" value="3" />
      <div class="muted">Value: <span id="energyV">3</span></div>
    </div>

    <div class="q">
      <div>Stress (1–5)</div>
      <input id="stress" type="range" min="1" max="5" value="3" />
      <div class="muted">Value: <span id="stressV">3</span></div>
    </div>

    <div class="q">
      <div>Activity (1–5)</div>
      <input id="activity" type="range" min="1" max="5" value="3" />
      <div class="muted">Value: <span id="activityV">3</span></div>
    </div>

    <div class="q">
      <div>Alcohol today?</div>
      <label><input id="alcohol" type="checkbox" /> Yes</label>
    </div>

    <div class="row">
      <button id="back">Back</button>
      <button class="primary" id="save">Save check-in</button>
    </div>
    <div class="muted" id="status" style="margin-top:8px;"></div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  const initData = tg?.initData || "";
  const user = tg?.initDataUnsafe?.user;
  document.getElementById("who").textContent =
    user ? Hi, ${user.first_name || "there"}! : "Open inside Telegram for full experience.";

  const todayEl = document.getElementById("today");
  const checkinEl = document.getElementById("checkin");

  const bindRange = (id) => {
    const r = document.getElementById(id);
    const v = document.getElementById(id + "V");
    r.addEventListener("input", () => v.textContent = r.value);
  };
  ["sleep","energy","stress","activity"].forEach(bindRange);

  document.getElementById("openCheckin").onclick = () => {
    todayEl.style.display = "none";
    checkinEl.style.display = "block";
  };
  document.getElementById("back").onclick = () => {
    checkinEl.style.display = "none";
    todayEl.style.display = "block";
  };

  function computeSomaLocal({sleep, energy, stress, activity, alcohol}) {
    const stressInv = 6 - stress;
    const base = (sleep*20)*0.35 + (energy*20)*0.30 + (stressInv*20)*0.20 + (activity*20)*0.15;
    const penalty = alcohol ? 10 : 0;
    return Math.max(0, Math.min(100, Math.round(base - penalty)));
  }

  async function refreshLatest() {
    if (!initData) return;
    const r = await fetch("/api/latest", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ initData })
    });
    if (!r.ok) return;
    const data = await r.json();
    if (data?.latest?.soma != null) {
      document.getElementById("score").textContent = SOMA ${data.latest.soma};
      document.getElementById("insight").textContent = data.latest.insight || "Based on your last check-in.";
    }
  }

  document.getElementById("save").onclick = async () => {
    const status = document.getElementById("status");
    status.textContent = "Saving…";

    const checkin = {
      sleep: +document.getElementById("sleep").value,
      energy: +document.getElementById("energy").value,
      stress: +document.getElementById("stress").value,
      activity: +document.getElementById("activity").value,
      alcohol: document.getElementById("alcohol").checked
    };
    const payload = { initData, checkin: { ...checkin, soma: computeSomaLocal(checkin) } };

    const r = await fetch("/api/save", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const text = await r.text();
    if (!r.ok) { status.textContent = "Error: " + text; return; }

    status.textContent = "Saved ✅";
    await refreshLatest();
    checkinEl.style.display = "none";
    todayEl.style.display = "block";
  };

  refreshLatest();
</script>
</body>
</html>
